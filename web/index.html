<!-- Inventory Display Area -->
<div id="inventory-section" style="margin-bottom: 20px;">
  <h3>User Inventory</h3>
  <ul id="inventory-list">Loading inventory...</ul>
</div>

<button onclick="pay()">Pay Now</button>
<button id="pay-again-btn" onclick="payAgain()" style="display:none;">
  Pay Again (Saved Payment)
</button>

<script>
async function loadInventory() {
  const list = document.getElementById("inventory-list");
  try {
    const res = await fetch("/api/inventories");
    const data = await res.json();

    if (!data || data.length === 0) {
      list.innerHTML = "<li>No items owned yet.</li>";
      return;
    }

    const grouped = data.reduce((acc, item) => {
      const uid = item.UserID;
      if (!acc[uid]) acc[uid] = [];
      acc[uid].push(item);
      return acc;
    }, {});

    // Clear loading text and map items to list elements
    list.innerHTML = Object.keys(grouped).map(userId => `
      <li style="margin-bottom: 15px; list-style: none;">
        <div style="background: #f4f4f4; padding: 5px 10px; border-radius: 4px;">
           <strong>ðŸ‘¤ User: ${userId}</strong>
        </div>
        <ul style="margin-top: 5px;">
          ${grouped[userId].map(item => `
            <li>
              ${item.ProductID || item.product_id}: 
              <strong>x${item.Quantity || item.quantity}</strong>
            </li>
          `).join("")}
        </ul>
      </li>
    `).join("");
  } catch (err) {
    list.innerHTML = "<li>Error loading inventory.</li>";
    console.error(err);
  }
}

async function checkSavedPayment() {
  try {
    const res = await fetch("/api/paypal/have-saved-payment");
    if (!res.ok) return;

    const data = await res.json();
    console.log("data", data)
    if (data.has_saved_payment) {
      document.getElementById("pay-again-btn").style.display = "inline-block";
    }
  } catch (err) {
    console.error("failed to check saved payment", err);
  }
}
async function pay() {
  const res = await fetch("/api/paypal/pay", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      items: [{ sku: "coin_100", quantity: 1 }],
    })
  });

  const data = await res.json();
  if (data.order_approval_url) {
    window.location.href = data.order_approval_url;
  }
}

async function payAgain() {
  const res = await fetch("/api/paypal/pay-again", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      items: [{ sku: "coin_100", quantity: 1 }],
    })
  });

  if (!res.ok) {
    alert("Saved payment failed, falling back to Pay Now");
    return pay();
  }

  alert("Payment successful ðŸŽ‰. Purchased items will be added to your inventory shortly!");
  loadInventory();
}

// initial load inventory
loadInventory();
checkSavedPayment();
</script>