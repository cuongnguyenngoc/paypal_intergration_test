<h2>PayPal Multi-Merchant Demo</h2>

<!-- Merchant Section -->
<div style="margin-bottom:20px;">
  <h3>Merchant</h3>

  <div id="merchant-info">
    <button onclick="createMerchant()">Create Merchant</button>
  </div>

  <div id="paypal-status" style="margin-top:10px; display:none;"></div>

  <div id="connect-section" style="margin-top:10px; display:none;">
    <button onclick="connectPaypal()">Connect PayPal</button>
  </div>

  <div id="disconnect-section" style="margin-top:10px; display:none;">
    <button onclick="disconnectPaypal()">Disconnect PayPal</button>
  </div>
</div>


<hr/>

<!-- Inventory Display Area -->
<div id="inventory-section" style="margin-bottom: 20px; display:none;">
  <h3>User Inventory</h3>
  <ul id="inventory-list">Loading inventory...</ul>
</div>

<button id="pay-btn" onclick="pay()" disabled>Pay Now</button>
<button id="pay-again-btn" onclick="payAgain()" style="display:none;">
  Pay Again (Saved Payment)
</button>

<hr/>

<!-- Subscription Section -->
<div id="subscription-section" style="margin-bottom:20px; display:none;">
  <h3>Subscription</h3>

  <button id="subscribe-btn" onclick="subscribe()" disabled>
    Subscribe (Monthly Plan)
  </button>

  <button id="cancel-sub-btn" onclick="cancelSubscription()" style="display:none;">
    Cancel Subscription
  </button>

  <div id="subscription-status" style="margin-top:10px;"></div>
</div>

<script>
const MERCHANT_KEY = "demo_merchant_id";

/* ---------------- Merchant ---------------- */

async function createMerchant() {
  const res = await fetch("/api/merchants/create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: "Demo Shop" })
  });

  if (!res.ok) return;

  const data = await res.json();
  localStorage.setItem(MERCHANT_KEY, data.id);

  document.getElementById("merchant-info").innerHTML =
    `<strong>Merchant ID:</strong> ${data.id}`;

  document.getElementById("connect-section").style.display = "block";
}

function connectPaypal() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  if (!merchantId) return alert("Create merchant first");

  window.location.href = `/api/merchants/${merchantId}/paypal/connect`;
}

async function checkPaypalStatus() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  if (!merchantId) return;

  const res = await fetch(`/api/merchants/${merchantId}/paypal/status`);
  if (!res.ok) return;

  const data = await res.json();
  console.log("data", data)

  document.getElementById("paypal-status").style.display = "block";

  if (data.connected) {
    document.getElementById("paypal-status").innerHTML =
      "‚úÖ PayPal connected";
    document.getElementById("connect-section").style.display = "none";
    document.getElementById("disconnect-section").style.display = "block";
    enablePayments();
  } else {
    document.getElementById("paypal-status").innerHTML =
      "‚ùå PayPal not connected";
    document.getElementById("connect-section").style.display = "block";
    document.getElementById("disconnect-section").style.display = "none";
    document.getElementById("pay-btn").disabled = true;
  }
}

async function disconnectPaypal() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  if (!merchantId) return;

  const res = await fetch(
    `/api/merchants/${merchantId}/paypal/disconnect`,
    { method: "POST" }
  );

  if (!res.ok) {
    alert("Failed to disconnect PayPal");
    return;
  }

  alert("PayPal disconnected");
  document.getElementById("pay-again-btn").style.display = "none";
  checkPaypalStatus();
}


/* ---------------- Inventory ---------------- */

async function loadInventory() {
  const list = document.getElementById("inventory-list");
  try {
    const res = await fetch("/api/inventories", {
      headers: merchantHeader(),
    });
    const data = await res.json();

    if (!data || data.length === 0) {
      list.innerHTML = "<li>No items owned yet.</li>";
      return;
    }

    list.innerHTML = data.map(item => `
      <li>
        ${item.product_id || item.ProductID} ‚Äî <strong>x${item.quantity || item.Quantity}</strong>
      </li>
    `).join("");
  } catch (err) {
    list.innerHTML = "<li>Error loading inventory.</li>";
  }
}

/* ---------------- Payments ---------------- */

async function checkSavedPayment() {
  const res = await fetch("/api/paypal/have-saved-payment", {
    headers: merchantHeader(),
  });
  if (!res.ok) return;

  const data = await res.json();
  if (data.has_saved_payment) {
    document.getElementById("pay-again-btn").style.display = "inline-block";
  }
}

async function pay() {
  const res = await fetch("/api/paypal/pay", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...merchantHeader(),
    },
    body: JSON.stringify({
      items: [{ sku: "coin_100", quantity: 1 }],
    })
  });

  const data = await res.json();
  if (data.order_approval_url) {
    window.location.href = data.order_approval_url;
  }
}

async function payAgain() {
  const res = await fetch("/api/paypal/pay-again", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...merchantHeader(),
    },
    body: JSON.stringify({
      items: [{ sku: "coin_100", quantity: 1 }],
    })
  });

  if (!res.ok) {
    alert("Saved payment failed, falling back to Pay Now");
    return pay();
  }

  alert("Payment successful üéâ Inventory will update shortly.");
  loadInventory();
}

async function subscribe() {
  const res = await fetch("/api/paypal/subscription/subscribe", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...merchantHeader(),
    },
    body: JSON.stringify({
      product_id: "vip_monthly",
    })
  });

  if (!res.ok) {
    alert("Failed to create subscription");
    return;
  }

  const data = await res.json();
  console.log("data.approval_url", data.approval_url)
  if (data.approval_url) {
    window.location.href = data.approval_url;
  }
}

async function checkSubscriptionStatus() {
  const res = await fetch("/api/paypal/subscription/status", {
    method: "GET",
    headers: merchantHeader(),
  });

  if (!res.ok) return;

  const data = await res.json();

  const statusDiv = document.getElementById("subscription-status");

  if (data.active) {
    statusDiv.innerHTML = "‚úÖ Subscription Active";
    document.getElementById("subscribe-btn").style.display = "none";
    document.getElementById("cancel-sub-btn").style.display = "inline-block";
  } else {
    statusDiv.innerHTML = "‚ùå Not Subscribed";
    document.getElementById("subscribe-btn").style.display = "inline-block";
    document.getElementById("cancel-sub-btn").style.display = "none";
  }
}

async function cancelSubscription() {
  const res = await fetch("/api/paypal/subscription/cancel", {
    method: "POST",
    headers: merchantHeader(),
  });

  if (!res.ok) {
    alert("Failed to cancel subscription");
    return;
  }

  alert("Subscription cancelled");
  checkSubscriptionStatus();
}

/* ---------------- Helpers ---------------- */

function merchantHeader() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  return merchantId ? { "X-Merchant-Id": merchantId } : {};
}

function enablePayments() {
  document.getElementById("pay-btn").disabled = false;
  document.getElementById("inventory-section").style.display = "block";
  document.getElementById("subscription-section").style.display = "block";
  document.getElementById("subscribe-btn").disabled = false;
}

/* ---------------- Init ---------------- */

(function init() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  if (!merchantId) return;

  document.getElementById("merchant-info").innerHTML =
    `<strong>Merchant ID:</strong> ${merchantId}`;
  document.getElementById("connect-section").style.display = "block";

  checkPaypalStatus();
  enablePayments();
  loadInventory();
  checkSavedPayment();
  checkSubscriptionStatus();
})();
</script>
