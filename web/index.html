<h2>PayPal Multi-Merchant Demo</h2>

<!-- Merchant Section -->
<div style="margin-bottom:20px;">
  <h3>Merchant</h3>

  <div id="merchant-info">
    <button onclick="createMerchant()">Create Merchant</button>
  </div>

  <div id="connect-section" style="display:none; margin-top:10px;">
    <button onclick="connectPaypal()">Connect PayPal</button>
  </div>
</div>

<hr/>

<!-- Inventory Display Area -->
<div id="inventory-section" style="margin-bottom: 20px; display:none;">
  <h3>User Inventory</h3>
  <ul id="inventory-list">Loading inventory...</ul>
</div>

<button id="pay-btn" onclick="pay()" disabled>Pay Now</button>
<button id="pay-again-btn" onclick="payAgain()" style="display:none;">
  Pay Again (Saved Payment)
</button>

<script>
const MERCHANT_KEY = "demo_merchant_id";

/* ---------------- Merchant ---------------- */

async function createMerchant() {
  const res = await fetch("/api/merchants/create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name: "Demo Shop" })
  });

  if (!res.ok) return;

  const data = await res.json();
  console.log("data", data)
  localStorage.setItem(MERCHANT_KEY, data.id);

  document.getElementById("merchant-info").innerHTML =
    `<strong>Merchant ID:</strong> ${data.id}`;

  document.getElementById("connect-section").style.display = "block";
}

function connectPaypal() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  if (!merchantId) return alert("Create merchant first");

  window.location.href = `/api/merchants/${merchantId}/paypal/connect`;
}

/* ---------------- Inventory ---------------- */

async function loadInventory() {
  const list = document.getElementById("inventory-list");
  try {
    const res = await fetch("/api/inventories", {
      headers: merchantHeader(),
    });
    const data = await res.json();

    if (!data || data.length === 0) {
      list.innerHTML = "<li>No items owned yet.</li>";
      return;
    }

    list.innerHTML = data.map(item => `
      <li>
        ${item.product_id || item.ProductID} â€” <strong>x${item.quantity || item.Quantity}</strong>
      </li>
    `).join("");
  } catch (err) {
    list.innerHTML = "<li>Error loading inventory.</li>";
  }
}

/* ---------------- Payments ---------------- */

async function checkSavedPayment() {
  const res = await fetch("/api/paypal/have-saved-payment", {
    headers: merchantHeader(),
  });
  if (!res.ok) return;

  const data = await res.json();
  if (data.has_saved_payment) {
    document.getElementById("pay-again-btn").style.display = "inline-block";
  }
}

async function pay() {
  const res = await fetch("/api/paypal/pay", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...merchantHeader(),
    },
    body: JSON.stringify({
      items: [{ sku: "coin_100", quantity: 1 }],
    })
  });

  const data = await res.json();
  if (data.order_approval_url) {
    window.location.href = data.order_approval_url;
  }
}

async function payAgain() {
  const res = await fetch("/api/paypal/pay-again", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...merchantHeader(),
    },
    body: JSON.stringify({
      items: [{ sku: "coin_100", quantity: 1 }],
    })
  });

  if (!res.ok) {
    alert("Saved payment failed, falling back to Pay Now");
    return pay();
  }

  alert("Payment successful ðŸŽ‰ Inventory will update shortly.");
  loadInventory();
}

/* ---------------- Helpers ---------------- */

function merchantHeader() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  return merchantId ? { "X-Merchant-Id": merchantId } : {};
}

function enablePayments() {
  document.getElementById("pay-btn").disabled = false;
  document.getElementById("inventory-section").style.display = "block";
}

/* ---------------- Init ---------------- */

(function init() {
  const merchantId = localStorage.getItem(MERCHANT_KEY);
  if (!merchantId) return;

  document.getElementById("merchant-info").innerHTML =
    `<strong>Merchant ID:</strong> ${merchantId}`;
  document.getElementById("connect-section").style.display = "block";

  enablePayments();
  loadInventory();
  checkSavedPayment();
})();
</script>
